<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P2P Hlukomƒõr</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }
      canvas {
        border: 1px solid black;
        margin-top: 10px;
      }
      button {
        margin: 5px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Hlukomƒõr üé§</h1>
    <button onclick="startMicrophone()">Zapnout mikrofon</button>
    <button onclick="startPeer()">P≈ôipojit k mikrofonu p≈ôes P2P</button>
    <button onclick="resetMaxVolume()">Reset maxima</button>
    <button onclick="acceptPeerOffer()">Vlo≈æit k√≥d druh√©ho za≈ô√≠zen√≠</button>
    <p>Hlasitost: <span id="volume">0</span></p>
    <p>Maxim√°ln√≠ hlasitost: <span id="maxVolume">0</span></p>
    <canvas id="visualizer" width="400" height="100"></canvas>
    <script>
      let peerConnection, dataChannel;
      let audioContext,
        analyser,
        volume = 0,
        maxVolume = 0;
      let canvas = document.getElementById("visualizer");
      let ctx = canvas.getContext("2d");

      function startMicrophone() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
          audioContext = new AudioContext();
          let source = audioContext.createMediaStreamSource(stream);
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          source.connect(analyser);

          updateVolume();
        });
      }

      function updateVolume() {
        let dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        volume = Math.max(...dataArray) / 255;
        maxVolume = Math.max(maxVolume, volume);

        document.getElementById("volume").innerText = (volume * 100).toFixed(1);
        document.getElementById("maxVolume").innerText = (
          maxVolume * 100
        ).toFixed(1);
        drawVolume();

        if (dataChannel && dataChannel.readyState === "open") {
          dataChannel.send(volume);
        }

        requestAnimationFrame(updateVolume);
      }

      function drawVolume() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "green";
        ctx.fillRect(0, 0, canvas.width * volume, canvas.height);
      }

      function resetMaxVolume() {
        maxVolume = 0;
        document.getElementById("maxVolume").innerText = "0";
      }

      function startPeer() {
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });
        dataChannel = peerConnection.createDataChannel("noise");

        peerConnection.onicecandidate = (event) => {
          if (!event.candidate) {
            prompt(
              "Po≈°li tento k√≥d druh√©mu za≈ô√≠zen√≠:",
              JSON.stringify(peerConnection.localDescription)
            );
          }
        };

        dataChannel.onmessage = (event) => {
          volume = parseFloat(event.data);
          maxVolume = Math.max(maxVolume, volume);
          document.getElementById("volume").innerText = (volume * 100).toFixed(
            1
          );
          document.getElementById("maxVolume").innerText = (
            maxVolume * 100
          ).toFixed(1);
          drawVolume();
        };

        peerConnection.createOffer().then((offer) => {
          return peerConnection.setLocalDescription(offer);
        });
      }

      function acceptPeerOffer() {
        let remoteOffer = JSON.parse(
          prompt("Vlo≈æ nab√≠dku (Offer) z druh√©ho za≈ô√≠zen√≠:")
        );
        peerConnection = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });

        peerConnection.ondatachannel = (event) => {
          dataChannel = event.channel;
          dataChannel.onmessage = (event) => {
            volume = parseFloat(event.data);
            maxVolume = Math.max(maxVolume, volume);
            document.getElementById("volume").innerText = (
              volume * 100
            ).toFixed(1);
            document.getElementById("maxVolume").innerText = (
              maxVolume * 100
            ).toFixed(1);
            drawVolume();
          };
        };

        peerConnection.onicecandidate = (event) => {
          if (!event.candidate) {
            prompt(
              "Po≈°li tento k√≥d zpƒõt prvn√≠mu za≈ô√≠zen√≠:",
              JSON.stringify(peerConnection.localDescription)
            );
          }
        };

        peerConnection
          .setRemoteDescription(remoteOffer)
          .then(() => {
            return peerConnection.createAnswer();
          })
          .then((answer) => {
            return peerConnection.setLocalDescription(answer);
          });
      }
    </script>
  </body>
</html>

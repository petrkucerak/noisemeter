<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hlukoměr - Ovládání</title>
  </head>
  <body>
    <h1>Hlukoměr - Ovládání</h1>
    <input type="text" id="name" placeholder="Název měření" />
    <button onclick="startMeasurement()">Spustit měření</button>
    <button onclick="stopMeasurement()">Zastavit měření</button>
    <button onclick="resetResults()">Resetovat výsledky</button>
    <button onclick="exportResults()">Export JSON</button>
    <input
      type="file"
      id="importFile"
      accept=".json"
      onchange="importResults(event)"
    />
    <p>Nejhlasitější naměřený hluk: <span id="maxNoise">0</span> dB</p>
    <canvas id="noiseCanvas" width="300" height="30"></canvas>

    <script>
      let audioContext, analyser, microphone;
      let measuring = false;
      let maxNoise = 0;
      let currentName = "";
      const canvas = document.getElementById("noiseCanvas");
      const ctx = canvas.getContext("2d");
      const channel = new BroadcastChannel("noise_data");

      async function startMeasurement() {
        const name = document.getElementById("name").value.trim();
        if (!name) {
          alert("Zadejte název měření před spuštěním!");
          return;
        }
        if (!measuring) {
          measuring = true;
          currentName = name;
          document.getElementById("name").disabled = true;

          // Načtení existujícího maxima nebo vytvoření nového záznamu
          let records = JSON.parse(localStorage.getItem("noiseRecords")) || [];
          const existingRecord = records.find((r) => r.name === currentName);
          maxNoise = existingRecord ? existingRecord.noise : 0;
          document.getElementById("maxNoise").textContent = maxNoise;

          if (!existingRecord) {
            records.push({ name: currentName, noise: maxNoise });
            localStorage.setItem("noiseRecords", JSON.stringify(records));
            channel.postMessage({ updateRanking: true });
          }

          try {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            microphone = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            microphone.connect(analyser);

            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function updateNoise() {
              if (!measuring) return;
              analyser.getByteFrequencyData(dataArray);
              let sum = dataArray.reduce((a, b) => a + b, 0);
              let noiseLevel = Math.round(sum / dataArray.length / 2);
              if (noiseLevel > maxNoise) {
                maxNoise = noiseLevel;
                document.getElementById("maxNoise").textContent = maxNoise;
                updateRecord(currentName, maxNoise);
              }

              channel.postMessage({ noiseLevel, maxNoise, name: currentName });
              drawNoiseLevel(noiseLevel);
              requestAnimationFrame(updateNoise);
            }
            updateNoise();
          } catch (err) {
            alert("Přístup k mikrofonu byl odepřen.");
            document.getElementById("name").disabled = false;
          }
        }
      }

      function stopMeasurement() {
        measuring = false;
        if (audioContext) audioContext.close();
        document.getElementById("name").disabled = false;
      }

      function updateRecord(name, noise) {
        let records = JSON.parse(localStorage.getItem("noiseRecords")) || [];
        const index = records.findIndex((r) => r.name === name);
        if (index !== -1) {
          records[index].noise = noise; // Přepíše pouze pokud je nová hodnota vyšší
        }
        records.sort((a, b) => b.noise - a.noise);
        records = records.slice(0, 5);
        localStorage.setItem("noiseRecords", JSON.stringify(records));
        channel.postMessage({ updateRanking: true });
      }

      function resetResults() {
        if (confirm("Opravdu chcete smazat všechny výsledky?")) {
          localStorage.removeItem("noiseRecords");
          maxNoise = 0;
          document.getElementById("maxNoise").textContent = maxNoise;
          channel.postMessage({ updateRanking: true });
          alert("Výsledky byly resetovány!");
        }
      }

      function exportResults() {
        const records = JSON.parse(localStorage.getItem("noiseRecords")) || [];
        const json = JSON.stringify(records, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "noise_records.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importResults(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedRecords = JSON.parse(e.target.result);
            if (Array.isArray(importedRecords)) {
              localStorage.setItem(
                "noiseRecords",
                JSON.stringify(importedRecords)
              );
              channel.postMessage({ updateRanking: true });
              alert("Data byla úspěšně importována!");
            } else {
              alert("Neplatný formát JSON!");
            }
          } catch (err) {
            alert("Chyba při importu: " + err.message);
          }
        };
        reader.readAsText(file);
      }

      function drawNoiseLevel(value) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let color = `rgb(${value * 2.5}, ${255 - value * 2.5}, 0)`;
        ctx.fillStyle = color;
        ctx.fillRect(0, 0, (canvas.width / 100) * value, canvas.height);
      }
    </script>
  </body>
</html>
